# azure-pipelines.yml
# Mirror unidireccional: Azure DevOps → GitHub (ramas + tags + LFS)
name: $(Date:yyyyMMdd).$(Rev:r)

trigger:
  branches: { include: ['*'] }
  tags:     { include: ['*'] }

schedules:
- cron: "0 6 * * *"           # 06:00 UTC diario (opcional)
  displayName: "Daily mirror to GitHub"
  branches: { include: ['*'] }
  always: true

pool:
  vmImage: 'ubuntu-latest'

# Variables en la UI del pipeline:
#   GITHUB_USER = tu-usuario (dueño del repo y creador del PAT)
#   GITHUB_PAT  = PAT de ese usuario (secret)
#   (opcional) GITHUB_OWNER = si no la defines, el script la iguala a GITHUB_USER

steps:
- checkout: self
  persistCredentials: true     # usa System.AccessToken para leer de ADO
  fetchDepth: 0

- script: |
    set -euo pipefail

    # --- Prechecks & defaults ---
    if [ -z "${GITHUB_USER:-}" ] || [ -z "${GITHUB_PAT:-}" ]; then
      echo "ERROR: Faltan GITHUB_USER o GITHUB_PAT (define ambas en Variables; PAT como secret)."
      exit 1
    fi
    # Si no pasan GITHUB_OWNER, usar el mismo usuario (owner = user)
    if [ -z "${GITHUB_OWNER:-}" ]; then
      GITHUB_OWNER="$GITHUB_USER"
    fi

    echo "Config git"
    git config --global user.name  "ado-mirror-bot"
    git config --global user.email "ado-mirror-bot@example.local"
    git config --global --add safe.directory "$(Build.SourcesDirectory)"

    echo "Instalar git-lfs (si aplica)…"
    if ! command -v git-lfs >/dev/null 2>&1; then
      sudo apt-get update -y
      sudo apt-get install -y git-lfs
      git lfs install
    fi

    TARGET_REPO="$(Build.Repository.Name)"
    echo "Repo ADO:    $(Build.Repository Uri)"
    echo "Repo GitHub: https://github.com/$GITHUB_OWNER/${TARGET_REPO}.git"

    echo "Config remoto GitHub con token…"
    git remote remove github 2>/dev/null || true
    git remote add github "https://$GITHUB_USER:$GITHUB_PAT@github.com/$GITHUB_OWNER/${TARGET_REPO}.git"

    echo "Verificando acceso a GitHub (ls-remote)…"
    if ! git ls-remote github &>/dev/null; then
      echo "ERROR: Sin acceso al repo GitHub ($GITHUB_OWNER/${TARGET_REPO})."
      echo "  - Verifica que $GITHUB_USER sea el owner o tenga Write."
      echo "  - PAT válido con 'repo' (o Contents: Read/Write) y SSO habilitado si la org lo exige."
      exit 1
    fi

    echo "Fetch desde origin (ADO)…"
    git fetch origin --prune --tags

    echo "Push ramas (origin/* → heads/*) con prune y force…"
    git push github +refs/remotes/origin/*:refs/heads/* --prune

    echo "Push tags con prune…"
    git push github --tags --prune

    echo "Empuje LFS (si existiera)…"
    git lfs fetch --all || true
    git lfs push --all github || true

    echo "Mirror completado: $GITHUB_OWNER/${TARGET_REPO}"
  displayName: "Mirror ADO → GitHub (branches & tags & LFS)"
  env:
    GITHUB_USER: $(GITHUB_USER)   # defínelas en la UI del pipeline
    GITHUB_PAT:  $(GITHUB_PAT)
    GITHUB_OWNER: $(GITHUB_OWNER)
